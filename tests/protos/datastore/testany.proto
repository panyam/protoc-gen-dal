
syntax = "proto3";

package datastore;

import "dal/v1/annotations.proto";
import "api/testany.proto";  // Import API protos so they're available for source references
import "google/protobuf/timestamp.proto";

option go_package = "github.com/panyam/protoc-gen-dal/tests/gen/datastore;testdatastore";

// TestRecord1Datastore demonstrates basic Datastore entity with enums and Any
message TestRecord1Datastore {
  option (dal.v1.datastore_options) = {
    source: "api.TestRecord1"
    kind: "test_records"
  };
}

// MapValueMessageDatastore is the Datastore model for api.MapValueMessage
message MapValueMessageDatastore {
  option (dal.v1.datastore_options) = {
    source: "api.MapValueMessage"
  };

  string label = 1;
  int32 count = 2;
}

// TestRecord2Datastore tests Datastore handling of maps with non-string keys.
// These maps contain proto message values with various key types.
message TestRecord2Datastore {
  option (dal.v1.datastore_options) = {
    source: "api.TestRecord2"
    kind: "test_records2"
  };

  // Map with int32 keys containing message values
  map<int32, MapValueMessageDatastore> int32_to_message = 2;

  // Map with int64 keys containing message values
  map<int64, MapValueMessageDatastore> int64_to_message = 3;

  // Map with uint32 keys containing message values
  map<uint32, MapValueMessageDatastore> uint32_to_message = 4;

  // Map with bool keys containing message values
  map<bool, MapValueMessageDatastore> bool_to_message = 5;
}

// TestRecord3Datastore tests Datastore handling of maps with scalar value types.
// This is the pattern used for counting likes by reaction type, etc.
// Google Cloud Datastore does NOT natively support map types, so the generated
// code implements PropertyLoadSaver to serialize maps as JSON.
message TestRecord3Datastore {
  option (dal.v1.datastore_options) = {
    source: "api.TestRecord3"
    kind: "test_records3"
    implement_property_loader: true
  };

  // The entity identifier (stored as datastore key name)
  string id = 1;

  // Entity type and ID being counted
  string entity_type = 2;
  string entity_id = 3;

  // Total count across all types
  int64 total_count = 4;

  // Counts broken down by type - this is the map field that needs PropertyLoadSaver
  map<string, int64> counts_by_type = 5 [(dal.v1.column) = {
    datastore_tags: ["noindex"]
  }];
}
