// Code generated by protoc-gen-dal-gorm. DO NOT EDIT.
package {{ .PackageName }}

{{ if .Imports }}
import (
{{- range .Imports }}
	{{ if .Alias }}{{ .Alias }} {{ end }}"{{ .Path }}"
{{- end }}
{{- if .HasRepeatedMessageConversions }}
	"fmt"
{{- end }}
	"time"

	"google.golang.org/protobuf/types/known/timestamppb"
)
{{ end }}

// Helper functions for built-in type conversions

// timestampToInt64 converts a protobuf Timestamp to Unix seconds (int64).
// Returns 0 if timestamp is nil.
func timestampToInt64(ts *timestamppb.Timestamp) int64 {
	if ts == nil {
		return 0
	}
	return ts.AsTime().Unix()
}

// int64ToTimestamp converts Unix seconds (int64) to a protobuf Timestamp.
// Returns nil if the input is 0.
func int64ToTimestamp(seconds int64) *timestamppb.Timestamp {
	if seconds == 0 {
		return nil
	}
	return timestamppb.New(time.Unix(seconds, 0))
}

{{ range .Converters }}
// {{ .SourceType }}To{{ .TargetType }} converts a {{ .SourcePkgName }}.{{ .SourceType }} to {{ .TargetType }}.
// The optional decorator function allows custom field transformations.
func {{ .SourceType }}To{{ .TargetType }}(
	src *{{ .SourcePkgName }}.{{ .SourceType }},
	dest *{{ .TargetType }},
	decorator func(*{{ .SourcePkgName }}.{{ .SourceType }}, *{{ .TargetType }}) error,
) (out *{{ .TargetType }}, err error) {
	if src == nil {
		return nil, nil
	}
	if dest == nil {
		dest = &{{ .TargetType }}{}
	}
	out = dest

	{{/* Process fields by conversion type */}}
	{{ range .FieldMappings }}
		{{/* ConvertByAssignment */}}
		{{ if eq .ToTargetConversionType 1 }}
			{{ if .SourceIsPointer }}
	if src.{{ .SourceField }} != nil {
		out.{{ .TargetField }} = {{ .ToTargetCode }}
	}
			{{ else }}
	out.{{ .TargetField }} = {{ .ToTargetCode }}
			{{ end }}

		{{/* ConvertByTransformer (no error) */}}
		{{ else if eq .ToTargetConversionType 2 }}
			{{ if .SourceIsPointer }}
	      if src.{{ .SourceField }} != nil {
		      out.{{ .TargetField }} = {{ .ToTargetCode }}
	      }
			{{ else }}
	      out.{{ .TargetField }} = {{ .ToTargetCode }}
			{{ end }}

		{{/* ConvertByTransformerWithError */}}
		{{ else if or (eq .ToTargetConversionType 3) (eq .ToTargetConversionType 4)}}
			{{ if .IsRepeated }}
				{{/* Loop-based conversion for []MessageType */}}
	if src.{{ .SourceField }} != nil {
		out.{{ .TargetField }} = make([]{{ .TargetElementType }}, len(src.{{ .SourceField }}))
		for i, item := range src.{{ .SourceField }} {
			_, err = {{ .ToTargetConverterFunc }}(item, &out.{{ .TargetField }}[i], nil)
			{{ if eq .ToTargetConversionType 3 }}
			if err != nil {
				return nil, fmt.Errorf("converting {{ .SourceField }}[%d]: %w", i, err)
			}
			{{ end }}
		}
	}
			{{ else if .IsMap }}
				{{/* Loop-based conversion for map<K, MessageType> */}}
	if src.{{ .SourceField }} != nil {
		out.{{ .TargetField }} = make(map[string]{{ .TargetElementType }}, len(src.{{ .SourceField }}))
		for key, value := range src.{{ .SourceField }} {
			var converted {{ .TargetElementType }}
			_, err = {{ .ToTargetConverterFunc }}(value, &converted, nil)
			{{ if eq .ToTargetConversionType 3 }}
			if err != nil {
				return nil, fmt.Errorf("converting {{ .SourceField }}[%s]: %w", key, err)
			}
			{{ end }}
			out.{{ .TargetField }}[key] = converted
		}
	}
			{{ else }}
				{{/* Regular message field conversion */}}
			{{ if .SourceIsPointer }} if src.{{ .SourceField }} != nil { {{ end }}
      _, err = {{ .ToTargetConverterFunc }}(src.{{ .SourceField }}, {{ fieldRef "out" .TargetField .TargetIsPointer }}, nil)
		  {{ if eq .ToTargetConversionType 3 }}
      if err != nil {
        return nil, fmt.Errorf("converting {{ .SourceField }}: %w", err)
      }
      {{ end }}
			{{ if .SourceIsPointer }} } {{ end }}
			{{ end }}
		{{ end }}
	{{ end }}

	// Apply decorator if provided
	if decorator != nil {
		if err := decorator(src, dest); err != nil {
			return nil, err
		}
	}

	return dest, nil
}

// {{ .SourceType }}From{{ .TargetType }} converts a {{ .TargetType }} back to {{ .SourcePkgName }}.{{ .SourceType }}.
// The optional decorator function allows custom field transformations.
func {{ .SourceType }}From{{ .TargetType }}(
	dest *{{ .SourcePkgName }}.{{ .SourceType }},
	src *{{ .TargetType }},
	decorator func(dest *{{ .SourcePkgName }}.{{ .SourceType }}, src *{{ .TargetType }}) error,
) (out *{{ .SourcePkgName }}.{{ .SourceType }}, err error) {
	if src == nil {
		return nil, nil
	}
	if dest == nil {
		dest = &{{ .SourcePkgName }}.{{ .SourceType }}{}
	}
	out = dest

	{{/* Process fields by conversion type */}}
	{{ range .FieldMappings }}
		{{/* ConvertByAssignment */}}
		{{ if eq .FromTargetConversionType 1 }}
			{{ if .TargetIsPointer }}
	if src.{{ .TargetField }} != nil {
		out.{{ .SourceField }} = {{ .FromTargetCode }}
	}
			{{ else }}
	out.{{ .SourceField }} = {{ .FromTargetCode }}
			{{ end }}

		{{/* ConvertByTransformer (no error) */}}
		{{ else if eq .FromTargetConversionType 2 }}
			{{ if .TargetIsPointer }}
	if src.{{ .TargetField }} != nil {
		out.{{ .SourceField }} = {{ .FromTargetCode }}
	}
			{{ else }}
	out.{{ .SourceField }} = {{ .FromTargetCode }}
			{{ end }}

		{{/* ConvertByTransformerWithError */}}
		{{/* ConvertByTransformerWithIgnorableError */}}
		{{ else if or (eq .FromTargetConversionType 3) (eq .FromTargetConversionType 4)}}
			{{ if .IsRepeated }}
				{{/* Loop-based conversion for []MessageType (from target) */}}
	if src.{{ .TargetField }} != nil {
		out.{{ .SourceField }} = make([]*{{ .SourcePkgName }}.{{ .SourceElementType }}, len(src.{{ .TargetField }}))
		for i, item := range src.{{ .TargetField }} {
			out.{{ .SourceField }}[i], err = {{ .FromTargetConverterFunc }}(nil, &item, nil)
			{{ if eq .FromTargetConversionType 3 }}
			if err != nil {
				return nil, fmt.Errorf("converting {{ .SourceField }}[%d]: %w", i, err)
			}
			{{ end }}
		}
	}
			{{ else if .IsMap }}
				{{/* Loop-based conversion for map<K, MessageType> (from target) */}}
	if src.{{ .TargetField }} != nil {
		out.{{ .SourceField }} = make(map[string]*{{ .SourcePkgName }}.{{ .SourceElementType }}, len(src.{{ .TargetField }}))
		for key, value := range src.{{ .TargetField }} {
			out.{{ .SourceField }}[key], err = {{ .FromTargetConverterFunc }}(nil, &value, nil)
			{{ if eq .FromTargetConversionType 3 }}
			if err != nil {
				return nil, fmt.Errorf("converting {{ .SourceField }}[%s]: %w", key, err)
			}
			{{ end }}
		}
	}
			{{ else }}
				{{/* Regular message field conversion (from target) */}}
			{{ if .TargetIsPointer }} if src.{{ .SourceField }} != nil { {{ end }}
      _, err = {{ .FromTargetConverterFunc }}(out.{{ .SourceField }}, {{ fieldRef "src" .TargetField .TargetIsPointer }}, nil)
		  {{ if eq .FromTargetConversionType 3 }}
      if err != nil {
        return nil, fmt.Errorf("converting {{ .SourceField }}: %w", err)
      }
      {{ end }}
			{{ if .TargetIsPointer }} } {{ end }}
			{{ end }}
		{{ end }}
	{{ end }}

	// Apply decorator if provided
	if decorator != nil {
		if err := decorator(dest, src); err != nil {
			return nil, err
		}
	}

	return out, nil
}
{{ end }}
