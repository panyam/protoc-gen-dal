// Code generated by protoc-gen-dal-datastore. DO NOT EDIT.
package {{ .PackageName }}

import (
{{ range .Imports }}
	{{ if .Alias }}{{ .Alias }} {{ end }}"{{ .Path }}"
{{ end }}
{{- if .HasRepeatedMessageConversions }}
	"fmt"
{{- end }}
	"strconv"

	"github.com/panyam/protoc-gen-dal/pkg/converters"
)

{{ range .Converters }}
// {{ .SourceType }}To{{ .TargetType }} converts a {{ .SourceType }} to {{ .TargetType }}.
//
// The optional decorator function allows custom field transformations after conversion.
//
// Parameters:
//   - src: Source {{ .SourceType }} message to convert from
//   - dest: Destination {{ .TargetType }} entity (if nil, a new one is created)
//   - decorator: Optional function for custom transformations
//
// Returns:
//   - Converted {{ .TargetType }} entity
//   - Error if conversion fails
func {{ .SourceType }}To{{ .TargetType }}(
	src *{{ .SourcePkgName }}.{{ .SourceType }},
	dest *{{ .TargetType }},
	decorator func(*{{ .SourcePkgName }}.{{ .SourceType }}, *{{ .TargetType }}) error,
) (out *{{ .TargetType }}, err error) {
	if src == nil {
		return nil, nil
	}
	if dest == nil {
		dest = &{{ .TargetType }}{}
	}

	// Initialize struct with inline values
	*dest = {{ .TargetType }}{
{{- range .ToTargetInlineFields }}
		{{ .TargetField }}: {{ if .ToTargetCode }}{{ .ToTargetCode }}{{ else }}src.{{ .SourceField }}{{ end }},
{{- end }}
	}
	out = dest

	{{/* Post-construction setters */}}
	{{- range .ToTargetSetterFields }}
		{{ if isSetterSimple .ToTargetRenderStrategy }}
			{{- if .SourceIsPointer }}
	if src.{{ .SourceField }} != nil {
		out.{{ .TargetField }} = {{ .ToTargetCode }}
	}
			{{ else }}
	out.{{ .TargetField }} = {{ .ToTargetCode }}
			{{ end }}
		{{ else if isSetterTransform .ToTargetRenderStrategy }}
			{{- if .SourceIsPointer }}
	if src.{{ .SourceField }} != nil {
		out.{{ .TargetField }} = {{ .ToTargetCode }}
	}
			{{- else }}
	out.{{ .TargetField }} = {{ .ToTargetCode }}
			{{- end }}
		{{ else if or (isSetterWithError .ToTargetRenderStrategy) (isSetterIgnoreError .ToTargetRenderStrategy) }}
			{{- if .ToTargetConverterFunc }}
				{{- /* Use converter function (message type conversions) */ -}}
				{{- if .SourceIsPointer }}if src.{{ .SourceField }} != nil { {{ end }}
	_, err = {{ .ToTargetConverterFunc }}(src.{{ .SourceField }}, {{ fieldRef "out" .TargetField .TargetIsPointer }}, nil)
				{{- if needsErrorCheck .ToTargetConversionType }}
	if err != nil {
		return nil, fmt.Errorf("converting {{ .SourceField }}: %w", err)
	}
				{{- end }}
				{{- if .SourceIsPointer }}}{{ end }}
			{{- else if .ToTargetCode }}
				{{- /* Use inline converter code (type mapping registry) */ -}}
				{{- if .SourceIsPointer }}
	if src.{{ .SourceField }} != nil {
				{{- end }}
		out.{{ .TargetField }}, err = {{ .ToTargetCode }}
				{{- if needsErrorCheck .ToTargetConversionType }}
		if err != nil {
			return nil, fmt.Errorf("converting {{ .SourceField }}: %w", err)
		}
				{{- end }}
				{{- if .SourceIsPointer }}
	}
				{{- end }}
			{{- end }}
		{{- end }}
	{{- end }}

	{{/* Loop-based conversions */}}
	{{- range .ToTargetLoopFields }}
		{{- if isLoopRepeated .ToTargetRenderStrategy }}
	if src.{{ .SourceField }} != nil {
		out.{{ .TargetField }} = make([]{{ .TargetElementType }}, len(src.{{ .SourceField }}))
		for i, item := range src.{{ .SourceField }} {
			_, err = {{ .ToTargetConverterFunc }}(item, &out.{{ .TargetField }}[i], nil)
			{{- if needsErrorCheck .ToTargetConversionType }}
			if err != nil {
				return nil, fmt.Errorf("converting {{ .SourceField }}[%d]: %w", i, err)
			}
			{{- end }}
		}
	}
		{{- else if isLoopMap .ToTargetRenderStrategy }}
	if src.{{ .SourceField }} != nil {
		out.{{ .TargetField }} = make(map[{{ .MapKeyType }}]{{ .TargetElementType }}, len(src.{{ .SourceField }}))
		for key, value := range src.{{ .SourceField }} {
			var converted {{ .TargetElementType }}
			_, err = {{ .ToTargetConverterFunc }}(value, &converted, nil)
			{{- if needsErrorCheck .ToTargetConversionType }}
			if err != nil {
				return nil, fmt.Errorf("converting {{ .SourceField }}[%v]: %w", key, err)
			}
			{{- end }}
			out.{{ .TargetField }}[key] = converted
		}
	}
		{{- end }}
	{{- end }}

	// Apply decorator if provided
	if decorator != nil {
		if err := decorator(src, dest); err != nil {
			return nil, err
		}
	}

	return dest, nil
}

// {{ .SourceType }}From{{ .TargetType }} converts a {{ .TargetType }} back to {{ .SourceType }}.
//
// The optional decorator function allows custom field transformations after conversion.
//
// Parameters:
//   - dest: Destination {{ .SourceType }} message (if nil, a new one is created)
//   - src: Source {{ .TargetType }} entity to convert from
//   - decorator: Optional function for custom transformations
//
// Returns:
//   - Converted {{ .SourceType }} message
//   - Error if conversion fails
func {{ .SourceType }}From{{ .TargetType }}(
	dest *{{ .SourcePkgName }}.{{ .SourceType }},
	src *{{ .TargetType }},
	decorator func(*{{ .SourcePkgName }}.{{ .SourceType }}, *{{ .TargetType }}) error,
) (out *{{ .SourcePkgName }}.{{ .SourceType }}, err error) {
	if src == nil {
		return nil, nil
	}
	if dest == nil {
		dest = &{{ .SourcePkgName }}.{{ .SourceType }}{}
	}

	// Initialize struct with inline values
	*dest = {{ .SourcePkgName }}.{{ .SourceType }}{
{{- range .FromTargetInlineFields }}
		{{ .SourceField }}: {{ if .FromTargetCode }}{{ .FromTargetCode }}{{ else }}src.{{ .TargetField }}{{ end }},
{{- end }}
	}
	out = dest

	{{/* Post-construction setters */}}
	{{- range .FromTargetSetterFields }}
		{{- if isSetterSimple .FromTargetRenderStrategy }}
			{{ if .TargetIsPointer }}
        if src.{{ .TargetField }} != nil {
          out.{{ .SourceField }} = {{ .FromTargetCode }}
        }
			{{ else }}
	      out.{{ .SourceField }} = {{ .FromTargetCode }}
			{{ end }}
		{{- else if isSetterTransform .FromTargetRenderStrategy }}
			{{ if .TargetIsPointer }}
        if src.{{ .TargetField }} != nil {
          out.{{ .SourceField }} = {{ .FromTargetCode }}
        }
			{{ else }}
	      out.{{ .SourceField }} = {{ .FromTargetCode }}
			{{ end }}
		{{- else if or (isSetterWithError .FromTargetRenderStrategy) (isSetterIgnoreError .FromTargetRenderStrategy) }}
			{{ if .FromTargetConverterFunc }}
				{{- /* Use converter function (message type conversions) */ -}}
				{{- if .TargetIsPointer }}if src.{{ .TargetField }} != nil { {{ end }}
	      out.{{ .SourceField }}, err = {{ .FromTargetConverterFunc }}(nil, {{ fieldRef "src" .TargetField .TargetIsPointer }}, nil)
				{{- if needsErrorCheck .FromTargetConversionType }}
        if err != nil {
          return nil, fmt.Errorf("converting {{ .SourceField }}: %w", err)
        }
				{{- end }}
				{{- if .TargetIsPointer }}}{{ end }}
			{{ else if .FromTargetCode }}
				{{- /* Use inline converter code (type mapping registry) */ -}}
				{{- if .TargetIsPointer }}
	if src.{{ .TargetField }} != nil {
				{{- end }}
		out.{{ .SourceField }}, err = {{ .FromTargetCode }}
				{{- if needsErrorCheck .FromTargetConversionType }}
		if err != nil {
			return nil, fmt.Errorf("converting {{ .SourceField }}: %w", err)
		}
				{{- end }}
				{{- if .TargetIsPointer }}
	}
				{{- end }}
			{{ end }}
		{{- end }}
	{{- end }}

	{{/* Loop-based conversions */}}
	{{- range .FromTargetLoopFields }}
		{{- if isLoopRepeated .FromTargetRenderStrategy }}
	if src.{{ .TargetField }} != nil {
		out.{{ .SourceField }} = make([]*{{ .SourcePkgName }}.{{ .SourceElementType }}, len(src.{{ .TargetField }}))
		for i, item := range src.{{ .TargetField }} {
			out.{{ .SourceField }}[i], err = {{ .FromTargetConverterFunc }}(nil, &item, nil)
			{{- if needsErrorCheck .FromTargetConversionType }}
			if err != nil {
				return nil, fmt.Errorf("converting {{ .TargetField }}[%d]: %w", i, err)
			}
			{{- end }}
		}
	}
		{{- else if isLoopMap .FromTargetRenderStrategy }}
	if src.{{ .TargetField }} != nil {
		out.{{ .SourceField }} = make(map[{{ .MapKeyType }}]*{{ .SourcePkgName }}.{{ .SourceElementType }}, len(src.{{ .TargetField }}))
		for key, value := range src.{{ .TargetField }} {
			out.{{ .SourceField }}[key], err = {{ .FromTargetConverterFunc }}(nil, &value, nil)
			{{- if needsErrorCheck .FromTargetConversionType }}
			if err != nil {
				return nil, fmt.Errorf("converting {{ .TargetField }}[%v]: %w", key, err)
			}
			{{- end }}
		}
	}
		{{- end }}
	{{- end }}

	// Apply decorator if provided
	if decorator != nil {
		if err := decorator(dest, src); err != nil {
			return nil, err
		}
	}

	return dest, nil
}
{{ end }}
